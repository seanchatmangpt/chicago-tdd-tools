# Cargo Nextest Configuration
# Fast unit tests (5s timeout with framework overhead) and slow integration tests (30s timeout)
#
# **Configuration Precedence**: This file (`.config/nextest.toml`) takes precedence over `nextest.toml` in workspace root
# When updating timeouts, update THIS file, not `nextest.toml` in root directory

[profile.default]
# Fast profile for unit tests (5s timeout for SLA compliance with test framework overhead)
# FMEA Fix: Increased from "1s" to "5s" to accommodate:
# - #[should_panic] test framework overhead (+0.1-0.2s)
# - Parallel test execution context switching (+0.5s)
# - Macro expansion overhead (+0.05-0.1s)
# Tests were timing out at 1.1-1.2s with aggressive 1s limit (RPN: 36)
slow-timeout = { period = "5s", terminate-after = 1 }

# Global timeout: 180 seconds for entire test suite
# Increased to accommodate weaver integration tests that need time to process telemetry
# (allows for parallel execution: 12 tests Ã— 5s = ~60s max, plus weaver tests up to 120s each)
global-timeout = "180s"

# Retry configuration (disabled for deterministic results)
retries = 0

# Parallel execution (faster test runs)
test-threads = "num-cpus"

# Output configuration
# **QFD Gap Analysis Fix**: Enable test status output to show real-time progress
# Addresses customer need: "I want to see progress while tests run"
# Note: status-level is a command-line flag, not a config option
# Progress is shown via cargo-nextest default output (test names as they run)
failure-output = "immediate"

# Exclude testcontainers integration tests from default profile
# These are slow and require Docker - use integration profile instead
# Note: Exclusion is done via command-line --skip flag in Makefile.toml

# **Root Cause Fix**: Add timeout override for weaver_integration tests
# Weaver integration tests need more time to process telemetry and generate reports
# Configuration precedence: `.config/nextest.toml` takes precedence over `nextest.toml` in root
[[profile.default.overrides]]
# Match all tests in weaver_integration test file
filter = 'test(weaver_integration)'
slow-timeout = { period = "120s", terminate-after = 1 }

[profile.integration]
# Slow profile for integration tests (30s timeout)
# Used for testcontainers tests that require Docker
slow-timeout = { period = "30s", terminate-after = 1 }

# Global timeout: 60 seconds for integration test suite
global-timeout = "60s"

# Retry configuration (disabled for deterministic results)
retries = 0

# Parallel execution (slower for integration tests)
test-threads = "num-cpus"

# Output configuration
# **QFD Gap Analysis Fix**: Enable test status output to show real-time progress
# Addresses customer need: "I want to see progress while tests run"
# Note: status-level is a command-line flag, not a config option
# Progress is shown via cargo-nextest default output (test names as they run)
failure-output = "immediate"
