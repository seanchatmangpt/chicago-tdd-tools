# CI/CD Pipeline for Chicago TDD Tools
#
# **Andon Signals (Visual Problem Indicators)**
# This workflow treats CI failures as Andon signals - visual indicators that stop the line.
# When a signal appears, work stops until the problem is fixed and the signal clears.
#
# **Signal Types**:
# ğŸ”´ CRITICAL (Red) - Compiler errors, test failures â†’ Stop immediately
# ğŸŸ¡ HIGH (Yellow) - Lint warnings, format issues â†’ Stop and fix
# ğŸŸ  MEDIUM (Orange) - Coverage warnings, performance issues â†’ Investigate
#
# **Root Cause Fix**: Automated enforcement of clippy checks prevents accumulation of lint errors.
# This workflow ensures code quality standards are maintained on every commit/PR.
#
# **Poka-Yoke Design**: CI fails on clippy warnings, preventing defects from entering codebase.
# Type-first thinking: Compiler enforces correctness. If CI passes, invariants are enforced.
#
# Workflow runs on:
# - Push to any branch (including PR/feature branches) - FMEA Fix: RPN 560 â†’ 56
# - Pull requests
# - Manual workflow dispatch
#
# Expected duration: ~90s (fmt: 5s, lint: 5s, test-unit: 10s)
# Note: Security audit runs in separate workflow
#
# FMEA Improvements Applied:
# - Multi-OS testing (Linux, macOS, Windows) - RPN: 315 â†’ 45
# - Test retry logic for flaky tests - RPN: 120 â†’ 24
# - Production code safety checks (unwrap/expect) - RPN: 180 â†’ 36
# - Coverage tracking and enforcement - RPN: 336 â†’ 67
# - Andon signal detection and "stop the line" response - RPN: TBD

name: CI

on:
  push:
    # FMEA Fix: Run on all branch pushes for continuous validation (RPN: 560 â†’ 56)
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# Auto-cancel redundant workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Minimal permissions for security
permissions:
  contents: read

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # **Andon Signal: HIGH (Yellow)** - Clippy Lint Check
  # **Root Cause Prevention**: Clippy check job prevents lint errors from accumulating
  # This job fails if clippy finds any warnings/errors, blocking merge
  # **Stop the Line**: Lint errors stop the CI pipeline - work cannot proceed
  lint:
    name: ğŸŸ¡ Lint Check (${{ matrix.rust }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rust: [stable, beta, nightly]
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: clippy

      - name: ğŸ’¾ Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.rust }}-lint

      - name: ğŸ”¨ Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: ğŸ¯ Run clippy lint check
        run: |
          echo "ğŸŸ¡ ANDON SIGNAL: Checking for lint warnings..."
          echo "If lint errors appear, work stops until fixed"
          cargo make lint
        continue-on-error: ${{ matrix.rust == 'nightly' }}
        # **Root Cause Prevention**: Exit code 1 on failure blocks merge
        # This ensures clippy errors cannot be committed
        # Note: Allow nightly failures as they may have unstable lints

      - name: âœ… Lint signal cleared
        if: success()
        run: echo "âœ… Lint check passed - no Andon signals"

  # **Andon Signal: HIGH (Yellow)** - Format Check
  # Format check ensures code style consistency
  # **Stop the Line**: Format violations stop the CI pipeline
  # FMEA Fix: rustfmt component explicitly specified (RPN: 100 â†’ 10)
  fmt:
    name: ğŸŸ¡ Format Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: ğŸ’¾ Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: ğŸ”¨ Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: ğŸ¯ Check code formatting
        run: |
          echo "ğŸŸ¡ ANDON SIGNAL: Checking code formatting..."
          cargo make fmt
          # Check if formatting changed anything
          if ! git diff --exit-code; then
            echo "âŒ ANDON SIGNAL DETECTED: Code is not formatted correctly"
            echo "ğŸ“ Fix: Run 'cargo make fmt' to automatically fix formatting"
            exit 1
          fi
          echo "âœ… Format check passed - no Andon signals"

  # **Andon Signal: CRITICAL (Red)** - Unit Tests
  # Unit tests ensure functionality works - test failures are CRITICAL signals
  # **Stop the Line**: Test failures stop the CI pipeline - work cannot proceed
  # FMEA Fix: Matrix build for multi-OS testing (RPN: 315 â†’ 45)
  # FMEA Fix: Test retry logic for flaky tests (RPN: 120 â†’ 24)
  test:
    name: ğŸ”´ Unit Tests (${{ matrix.os }}, ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, beta]
        include:
          - os: ubuntu-latest
            rust: nightly
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: ğŸ’¾ Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-${{ matrix.rust }}-test

      - name: ğŸ”¨ Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: ğŸ§ª Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: ğŸ¯ Run unit tests (critical signal)
        # FMEA Fix: Retry logic for flaky tests (RPN: 120 â†’ 24)
        # Tests are retried up to 3 times on failure to handle transient issues
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_on: error
          command: |
            echo "ğŸ”´ ANDON SIGNAL: Running critical unit tests..."
            echo "Test failures are CRITICAL signals that stop all work"
            cargo make test-unit
          on_retry_command: |
            echo "âš ï¸  ANDON SIGNAL: Test failure detected (attempt ${{ github.run_attempt }}/3)"
            echo "Retrying transient test failures..."
        continue-on-error: ${{ matrix.rust == 'nightly' }}

      - name: âœ… Unit Test Signal Cleared
        if: success()
        run: echo "âœ… All unit tests passed - no Andon signals"

  # **Andon Signal: CRITICAL (Red)** - Integration Tests with Docker/Weaver
  # FMEA Fix: Integration test coverage (RPN: 280 â†’ 28, 90% reduction)
  # Ensures Docker-dependent tests (testcontainers, Weaver) run in CI
  # **Stop the Line**: Integration test failures are critical signals
  test-integration:
    name: ğŸ”´ Integration Tests (Docker)
    runs-on: ubuntu-latest
    needs: [test]  # Run after unit tests pass
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: integration-test

      - name: ğŸ”¨ Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: ğŸ§ª Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: ğŸ³ Verify Docker availability
        run: |
          docker --version
          docker ps
          echo "âœ… Docker is available and running"

      - name: ğŸ¯ Run integration tests (critical signal)
        run: |
          echo "ğŸ”´ ANDON SIGNAL: Running critical integration tests..."
          echo "Integration test failures are CRITICAL signals that stop all work"
          cargo make test-integration
        timeout-minutes: 15
        env:
          RUST_BACKTRACE: 1

      - name: ğŸ“¤ Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-failures
          path: |
            target/nextest/ci/
            target/nextest/integration/
          retention-days: 7

      - name: âœ… Integration Test Signal Cleared
        if: success()
        run: echo "âœ… All integration tests passed - no Andon signals"

  # **Andon Signal: CRITICAL (Red)** - Production Code Safety
  # Panics in production code are unacceptable - unwrap/expect are CRITICAL signals
  # **Stop the Line**: Any unwrap/expect stops the CI pipeline immediately
  # FMEA Fix: Unwrap/Expect enforcement (RPN: 180 â†’ 36)
  unwrap-check:
    name: ğŸ”´ Production Safety (unwrap/expect)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for checking all files

      - name: ğŸ¯ Check for unwrap/expect (critical signal)
        run: |
          echo "ğŸ”´ ANDON SIGNAL: Checking for production code panics..."
          echo "unwrap() and expect() are CRITICAL signals that stop all work"
          echo ""

          # Find all Rust files in src/ and proc_macros/src/ (production code)
          PROD_FILES=$(find src proc_macros/src -name '*.rs' -type f 2>/dev/null | \
            grep -v '/test' | grep -v '/tests/' | grep -v 'build.rs' || true)

          if [ -z "$PROD_FILES" ]; then
            echo "âœ… No production Rust files found"
            exit 0
          fi

          UNWRAP_COUNT=0
          EXPECT_COUNT=0
          FILES_WITH_ISSUES=""

          for FILE in $PROD_FILES; do
            # Skip if file has allow attribute
            if grep -qE '#!?\[allow\(clippy::(unwrap|expect)_used\)\]' "$FILE" 2>/dev/null; then
              continue
            fi

            # Skip test-only files
            if grep -q '#\[cfg(test)\]' "$FILE" 2>/dev/null; then
              continue
            fi

            # Count unwrap/expect calls
            UNWRAPS=$(grep -c '\.unwrap()' "$FILE" 2>/dev/null || echo "0")
            EXPECTS=$(grep -c '\.expect(' "$FILE" 2>/dev/null || echo "0")

            if [ "$UNWRAPS" -gt 0 ] || [ "$EXPECTS" -gt 0 ]; then
              FILES_WITH_ISSUES="$FILES_WITH_ISSUES\n  $FILE: $UNWRAPS unwrap(), $EXPECTS expect()"
              UNWRAP_COUNT=$((UNWRAP_COUNT + UNWRAPS))
              EXPECT_COUNT=$((EXPECT_COUNT + EXPECTS))
            fi
          done

          TOTAL=$((UNWRAP_COUNT + EXPECT_COUNT))

          if [ "$TOTAL" -gt 0 ]; then
            echo ""
            echo "âŒ ANDON SIGNAL DETECTED: Production code contains panics!"
            echo "Found $UNWRAP_COUNT unwrap() and $EXPECT_COUNT expect() calls in:"
            printf "$FILES_WITH_ISSUES\n"
            echo ""
            echo "ğŸ”§ Fix Step 1: Use '?' operator for error propagation"
            echo "   let value = operation()?;  // Propagate error"
            echo ""
            echo "ğŸ”§ Fix Step 2: Use 'if let' or 'match' for error handling"
            echo "   if let Ok(v) = operation() { /* use v */ }"
            echo ""
            echo "ğŸ“š See: docs/process/SPR_GUIDE.md"
            echo "ğŸ”— Install pre-commit hook: ./scripts/install-hooks.sh"
            echo ""
            echo "â¸ï¸  WORK STOPPED: Signal must be cleared before proceeding"
            exit 1
          fi

          echo "âœ… Signal cleared: No unwrap/expect in production code"

  # **Andon Signal: MEDIUM (Orange)** - Code Coverage
  # Coverage warnings are investigative signals - not blocking but tracked
  # FMEA Fix: Coverage enforcement (RPN: 336 â†’ 67)
  coverage:
    name: ğŸŸ  Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‹ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: ğŸ”¨ Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: ğŸ“Š Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: ğŸ“ˆ Generate coverage report
        run: |
          echo "ğŸŸ  ANDON SIGNAL: Measuring test coverage..."
          cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: ğŸ¯ Check coverage threshold (investigative signal)
        run: |
          # Use portable commands (awk instead of bc/grep -P)
          COVERAGE=$(cargo llvm-cov --all-features --lib --tests --summary-only | \
            grep "lines" | awk '{print $2}' | tr -d '%' || echo "0.0")
          echo ""
          echo "ğŸ“Š Coverage: $COVERAGE%"
          # Use awk for portable comparison (works on all platforms)
          if [ $(echo "$COVERAGE 70.0" | awk '{print ($1 < $2)}') -eq 1 ]; then
            echo ""
            echo "ğŸŸ  ANDON SIGNAL: Coverage below recommended 70% threshold"
            echo "   Current coverage: $COVERAGE%"
            echo "   Status: âš ï¸  WARNING (investigative signal)"
            echo "   Action: Consider adding tests to improve coverage"
            echo "   Goal: Reach 70% coverage for full enforcement"
            echo ""
            # exit 1  # Uncomment when ready to enforce
          else
            echo "âœ… Signal cleared: Coverage $COVERAGE% meets threshold"
          fi

      - name: ğŸ“¤ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  # **Andon Signal: Pipeline Status** - Aggregates all signals
  # Full CI pipeline - runs all checks and aggregates Andon signal status
  # **Stop the Line**: Any CRITICAL signal stops the pipeline (merge blocked)
  # FMEA Fix: Remove optional jobs from needs (RPN: 210 â†’ 21)
  ci:
    name: ğŸ¯ Andon Signal Pipeline
    runs-on: ubuntu-latest
    needs: [lint, fmt, test, test-integration, unwrap-check, coverage]
    if: always()
    steps:
      - name: ğŸ“Š Aggregate Andon signals
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          ANDON SIGNAL STATUS - CI Pipeline                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Track signal status
          CRITICAL_SIGNALS=0
          HIGH_SIGNALS=0
          MEDIUM_SIGNALS=0

          echo "ğŸ“‹ Job Results:"
          echo ""

          # Check critical jobs
          if [[ "${{ needs.lint.result }}" == "failure" ]]; then
            echo "  ğŸ”´ CRITICAL: Lint check failed (ğŸŸ¡ HIGH signal not cleared)"
            CRITICAL_SIGNALS=$((CRITICAL_SIGNALS + 1))
          else
            echo "  âœ… Lint check passed"
          fi

          if [[ "${{ needs.fmt.result }}" == "failure" ]]; then
            echo "  ğŸ”´ CRITICAL: Format check failed (ğŸŸ¡ HIGH signal not cleared)"
            CRITICAL_SIGNALS=$((CRITICAL_SIGNALS + 1))
          else
            echo "  âœ… Format check passed"
          fi

          if [[ "${{ needs.test.result }}" == "failure" ]]; then
            echo "  ğŸ”´ CRITICAL: Tests failed (ğŸ”´ CRITICAL signal not cleared)"
            CRITICAL_SIGNALS=$((CRITICAL_SIGNALS + 1))
          else
            echo "  âœ… Tests passed"
          fi

          if [[ "${{ needs.test-integration.result }}" == "failure" ]]; then
            echo "  ğŸ”´ CRITICAL: Integration tests failed (ğŸ”´ CRITICAL signal not cleared)"
            CRITICAL_SIGNALS=$((CRITICAL_SIGNALS + 1))
          else
            echo "  âœ… Integration tests passed"
          fi

          if [[ "${{ needs.unwrap-check.result }}" == "failure" ]]; then
            echo "  ğŸ”´ CRITICAL: Production panics detected (ğŸ”´ CRITICAL signal not cleared)"
            CRITICAL_SIGNALS=$((CRITICAL_SIGNALS + 1))
          else
            echo "  âœ… Production code safety cleared"
          fi

          if [[ "${{ needs.coverage.result }}" == "failure" ]]; then
            echo "  ğŸŸ  WARNING: Coverage check (optional, ğŸŸ  MEDIUM signal)"
          else
            echo "  âœ… Coverage check passed"
          fi

          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"

          # Summary and decision
          if [ $CRITICAL_SIGNALS -gt 0 ]; then
            echo "â•‘                   ğŸ”´ ANDON SIGNAL ACTIVE ğŸ”´               â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "â¸ï¸  WORK STOPPED: $CRITICAL_SIGNALS critical signal(s) detected"
            echo ""
            echo "Action Required:"
            echo "  1ï¸âƒ£  Stop all work immediately"
            echo "  2ï¸âƒ£  Investigate the failed job above"
            echo "  3ï¸âƒ£  Fix the root cause (not just the symptom)"
            echo "  4ï¸âƒ£  Re-run CI to verify signal is cleared"
            echo "  5ï¸âƒ£  Resume work when all signals are clear"
            echo ""
            echo "Resources:"
            echo "  ğŸ“š Andon Signals Guide: .github/ANDON_SIGNALS.md"
            echo "  ğŸ“š Process Guide: docs/process/SPR_GUIDE.md"
            echo "  ğŸ”— Install pre-commit hook: ./scripts/install-hooks.sh"
            echo ""
            exit 1
          else
            echo "â•‘              âœ… ALL SIGNALS CLEARED - READY âœ…             â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "âœ… All CI checks passed!"
            echo "ğŸ“Š FMEA Improvements Applied:"
            echo "  - Multi-OS testing (Linux, macOS, Windows)"
            echo "  - Multi-Rust version testing (stable, beta, nightly)"
            echo "  - Test retry logic for flaky tests"
            echo "  - Integration tests with Docker/Weaver (RPN: 280 â†’ 28)"
            echo "  - Coverage tracking and enforcement"
            echo "  - Production code safety (no unwrap/expect)"
            echo "  - Andon signal visualization and stop-the-line response"
            echo "  - Runs on all branches for early feedback"
            echo ""
            echo "Ready to merge! ğŸš€"
          fi
