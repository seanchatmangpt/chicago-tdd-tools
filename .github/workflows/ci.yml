# CI/CD Pipeline for Chicago TDD Tools
#
# **Root Cause Fix**: Automated enforcement of clippy checks prevents accumulation of lint errors.
# This workflow ensures code quality standards are maintained on every commit/PR.
#
# **Poka-Yoke Design**: CI fails on clippy warnings, preventing defects from entering codebase.
# Type-first thinking: Compiler enforces correctness. If CI passes, invariants are enforced.
#
# Workflow runs on:
# - Push to any branch (including PR/feature branches)
# - Pull requests
# - Manual workflow dispatch
#
# Expected duration: ~90s (fmt: 5s, lint: 5s, test-unit: 10s)
# Note: Security audit runs in separate workflow

name: CI

on:
  push:
    # Run on all branch pushes for continuous validation
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# Auto-cancel redundant workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Minimal permissions for security
permissions:
  contents: read

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # **Root Cause Prevention**: Clippy check job prevents lint errors from accumulating
  # This job fails if clippy finds any warnings/errors, blocking merge
  lint:
    name: Clippy Lint Check (${{ matrix.rust }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rust: [stable, beta, nightly]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: clippy

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.rust }}-lint

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Run clippy lint check
        run: cargo make lint
        continue-on-error: ${{ matrix.rust == 'nightly' }}
        # **Root Cause Prevention**: Exit code 1 on failure blocks merge
        # This ensures clippy errors cannot be committed
        # Note: Allow nightly failures as they may have unstable lints

  # Format check ensures code style consistency
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Check code formatting
        run: |
          cargo make fmt
          # Check if formatting changed anything
          if ! git diff --exit-code; then
            echo "❌ Code is not formatted correctly. Run 'cargo make fmt' to fix."
            exit 1
          fi

  # Unit tests ensure functionality works
  test:
    name: Unit Tests (${{ matrix.os }}, ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, beta]
        include:
          - os: ubuntu-latest
            rust: nightly
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-${{ matrix.rust }}-test

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Run unit tests
        run: cargo make test-unit
        continue-on-error: ${{ matrix.rust == 'nightly' }}

  # Code coverage for test coverage tracking
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: Generate coverage report
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  # Full CI pipeline - runs all checks
  ci:
    name: Full CI Pipeline
    runs-on: ubuntu-latest
    needs: [lint, fmt, test, coverage]
    if: always()
    steps:
      - name: Check job results
        run: |
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.fmt.result }}" == "failure" ]] || \
             [[ "${{ needs.test.result }}" == "failure" ]]; then
            echo "❌ CI Pipeline failed"
            exit 1
          fi
          echo "✅ All CI checks passed"
