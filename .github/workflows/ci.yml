# CI/CD Pipeline for Chicago TDD Tools
#
# **Root Cause Fix**: Automated enforcement of clippy checks prevents accumulation of lint errors.
# This workflow ensures code quality standards are maintained on every commit/PR.
#
# **Poka-Yoke Design**: CI fails on clippy warnings, preventing defects from entering codebase.
# Type-first thinking: Compiler enforces correctness. If CI passes, invariants are enforced.
#
# Workflow runs on:
# - Push to main/master branches
# - Pull requests
# - Manual workflow dispatch
#
# Expected duration: ~120s (fmt: 5s, lint: 5s, test-unit: 10s, audit: 30s)

name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# Auto-cancel redundant workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Minimal permissions for security
permissions:
  contents: read

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # **Root Cause Prevention**: Clippy check job prevents lint errors from accumulating
  # This job fails if clippy finds any warnings/errors, blocking merge
  lint:
    name: Clippy Lint Check (${{ matrix.rust }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        rust: [stable, beta]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: clippy

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.rust }}-lint

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Run clippy lint check
        run: cargo make lint
        # **Root Cause Prevention**: Exit code 1 on failure blocks merge
        # This ensures clippy errors cannot be committed

  # Format check ensures code style consistency
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Check code formatting
        run: |
          cargo make fmt
          # Check if formatting changed anything
          if ! git diff --exit-code; then
            echo "‚ùå Code is not formatted correctly. Run 'cargo make fmt' to fix."
            exit 1
          fi

  # Unit tests ensure functionality works
  test:
    name: Unit Tests (${{ matrix.os }}, ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, beta]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-${{ matrix.rust }}-test

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Run unit tests with retry
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 2
          retry_on: error
          command: cargo make test-unit

  # Security audit checks for vulnerabilities
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Install cargo-audit
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: Run security audit
        id: audit
        run: cargo make audit
        continue-on-error: true  # Audit failures are warnings, not blockers

      - name: Report audit issues
        if: failure() && steps.audit.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è  SECURITY AUDIT FAILED"
          echo "::warning::Security vulnerabilities detected. Please review cargo audit output above."
          echo "This is a warning only and does not block CI, but should be addressed."

  # Code coverage for test coverage tracking
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: Generate coverage report
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  # Full CI pipeline - runs all checks
  ci:
    name: Full CI Pipeline
    runs-on: ubuntu-latest
    needs: [lint, fmt, test, audit, coverage]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "üîç Validating CI Pipeline Results..."
          echo ""

          # Track failures
          FAILURES=0

          # Check lint result
          if [[ "${{ needs.lint.result }}" == "failure" ]]; then
            echo "‚ùå Lint job failed"
            FAILURES=$((FAILURES + 1))
          elif [[ "${{ needs.lint.result }}" == "success" ]]; then
            echo "‚úÖ Lint job passed"
          else
            echo "‚ö†Ô∏è  Lint job: ${{ needs.lint.result }}"
          fi

          # Check fmt result
          if [[ "${{ needs.fmt.result }}" == "failure" ]]; then
            echo "‚ùå Format check failed"
            FAILURES=$((FAILURES + 1))
          elif [[ "${{ needs.fmt.result }}" == "success" ]]; then
            echo "‚úÖ Format check passed"
          else
            echo "‚ö†Ô∏è  Format check: ${{ needs.fmt.result }}"
          fi

          # Check test result (includes matrix jobs)
          if [[ "${{ needs.test.result }}" == "failure" ]]; then
            echo "‚ùå Test job failed (one or more platforms/toolchains)"
            FAILURES=$((FAILURES + 1))
          elif [[ "${{ needs.test.result }}" == "success" ]]; then
            echo "‚úÖ Test job passed (all platforms/toolchains)"
          else
            echo "‚ö†Ô∏è  Test job: ${{ needs.test.result }}"
          fi

          # Check audit result (warning only, not blocking)
          if [[ "${{ needs.audit.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è  Security audit found issues (non-blocking)"
          elif [[ "${{ needs.audit.result }}" == "success" ]]; then
            echo "‚úÖ Security audit passed"
          else
            echo "‚ÑπÔ∏è  Security audit: ${{ needs.audit.result }}"
          fi

          # Check coverage result (warning only, not blocking)
          if [[ "${{ needs.coverage.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è  Coverage job failed (non-blocking)"
          elif [[ "${{ needs.coverage.result }}" == "success" ]]; then
            echo "‚úÖ Coverage job passed"
          else
            echo "‚ÑπÔ∏è  Coverage job: ${{ needs.coverage.result }}"
          fi

          echo ""

          if [ $FAILURES -gt 0 ]; then
            echo "‚ùå CI Pipeline FAILED with $FAILURES critical failure(s)"
            echo ""
            echo "Required jobs (must pass):"
            echo "  - Lint: ${{ needs.lint.result }}"
            echo "  - Format: ${{ needs.fmt.result }}"
            echo "  - Tests: ${{ needs.test.result }}"
            echo ""
            echo "Optional jobs (warnings only):"
            echo "  - Audit: ${{ needs.audit.result }}"
            echo "  - Coverage: ${{ needs.coverage.result }}"
            exit 1
          fi

          echo "‚úÖ All required CI checks passed!"
          echo ""
          echo "Summary:"
          echo "  - Lint: ${{ needs.lint.result }}"
          echo "  - Format: ${{ needs.fmt.result }}"
          echo "  - Tests: ${{ needs.test.result }}"
          echo "  - Audit: ${{ needs.audit.result }}"
          echo "  - Coverage: ${{ needs.coverage.result }}"
