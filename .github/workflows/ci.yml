# CI/CD Pipeline for Chicago TDD Tools
#
# **Root Cause Fix**: Automated enforcement of clippy checks prevents accumulation of lint errors.
# This workflow ensures code quality standards are maintained on every commit/PR.
#
# **Poka-Yoke Design**: CI fails on clippy warnings, preventing defects from entering codebase.
# Type-first thinking: Compiler enforces correctness. If CI passes, invariants are enforced.
#
# Workflow runs on:
# - Push to any branch (including PR/feature branches) - FMEA Fix: RPN 560 ‚Üí 56
# - Pull requests
# - Manual workflow dispatch
#
# Expected duration: ~90s (fmt: 5s, lint: 5s, test-unit: 10s)
# Note: Security audit runs in separate workflow
#
# FMEA Improvements Applied:
# - Multi-OS testing (Linux, macOS, Windows) - RPN: 315 ‚Üí 45
# - Test retry logic for flaky tests - RPN: 120 ‚Üí 24
# - Production code safety checks (unwrap/expect) - RPN: 180 ‚Üí 36
# - Coverage tracking and enforcement - RPN: 336 ‚Üí 67

name: CI

on:
  push:
    # FMEA Fix: Run on all branch pushes for continuous validation (RPN: 560 ‚Üí 56)
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# Auto-cancel redundant workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Minimal permissions for security
permissions:
  contents: read

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # **Root Cause Prevention**: Clippy check job prevents lint errors from accumulating
  # This job fails if clippy finds any warnings/errors, blocking merge
  lint:
    name: Clippy Lint Check (${{ matrix.rust }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rust: [stable, beta, nightly]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: clippy

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.rust }}-lint

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Run clippy lint check
        run: cargo make lint
        continue-on-error: ${{ matrix.rust == 'nightly' }}
        # **Root Cause Prevention**: Exit code 1 on failure blocks merge
        # This ensures clippy errors cannot be committed
        # Note: Allow nightly failures as they may have unstable lints

  # Format check ensures code style consistency
  # FMEA Fix: rustfmt component explicitly specified (RPN: 100 ‚Üí 10)
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Check code formatting
        run: |
          cargo make fmt
          # Check if formatting changed anything
          if ! git diff --exit-code; then
            echo "‚ùå Code is not formatted correctly. Run 'cargo make fmt' to fix."
            exit 1
          fi

  # Unit tests ensure functionality works
  # FMEA Fix: Matrix build for multi-OS testing (RPN: 315 ‚Üí 45)
  # FMEA Fix: Test retry logic for flaky tests (RPN: 120 ‚Üí 24)
  test:
    name: Unit Tests (${{ matrix.os }}, ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, beta]
        include:
          - os: ubuntu-latest
            rust: nightly
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-${{ matrix.rust }}-test

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Run unit tests
        # FMEA Fix: Retry logic for flaky tests (RPN: 120 ‚Üí 24)
        # Tests are retried up to 3 times on failure to handle transient issues
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_on: error
          command: cargo make test-unit
          on_retry_command: |
            echo "‚ö†Ô∏è  Test run failed, retrying (attempt ${{ github.run_attempt }}/3)..."
            echo "This may indicate a flaky test. Please investigate."
        continue-on-error: ${{ matrix.rust == 'nightly' }}

  # Integration tests with Docker/Weaver
  # FMEA Fix: Integration test coverage (RPN: 280 ‚Üí 28, 90% reduction)
  # Ensures Docker-dependent tests (testcontainers, Weaver) run in CI
  test-integration:
    name: Integration Tests (Docker)
    runs-on: ubuntu-latest
    needs: [test] # Run after unit tests pass
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: integration-test

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Verify Docker availability
        # FMEA Fix: Fail gracefully if Docker unavailable (RPN reduction)
        run: |
          if ! command -v docker &> /dev/null; then
            echo "‚ùå ERROR: Docker is not installed"
            exit 1
          fi
          if ! docker --version; then
            echo "‚ùå ERROR: Docker command failed"
            exit 1
          fi
          if ! docker ps &> /dev/null; then
            echo "‚ùå ERROR: Docker daemon is not running"
            echo "Integration tests require Docker to be available and running"
            exit 1
          fi
          echo "‚úÖ Docker is available and running"

      - name: Run integration tests
        run: cargo make test-integration
        timeout-minutes: 15
        env:
          RUST_BACKTRACE: 1

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-failures
          path: |
            target/nextest/ci/
            target/nextest/integration/
          retention-days: 7

  # FMEA Fix: Unwrap/Expect enforcement (RPN: 180 ‚Üí 36)
  unwrap-check:
    name: Production Code Safety (unwrap/expect)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for checking all files

      - name: Check for unwrap/expect in production code
        run: |
          echo "üîç Checking for .unwrap() and .expect() in production code..."

          # Find all Rust files in src/ and proc_macros/src/ (production code)
          PROD_FILES=$(find src proc_macros/src -name '*.rs' -type f 2>/dev/null | \
            grep -v '/test' | grep -v '/tests/' | grep -v 'build.rs' || true)

          if [ -z "$PROD_FILES" ]; then
            echo "‚úÖ No production Rust files found"
            exit 0
          fi

          UNWRAP_COUNT=0
          EXPECT_COUNT=0
          FILES_WITH_ISSUES=""

          for FILE in $PROD_FILES; do
            # Skip if file has allow attribute
            if grep -qE '#!?\[allow\(clippy::(unwrap|expect)_used\)\]' "$FILE" 2>/dev/null; then
              continue
            fi

            # Skip test-only files
            if grep -q '#\[cfg(test)\]' "$FILE" 2>/dev/null; then
              continue
            fi

            # Count unwrap/expect calls
            UNWRAPS=$(grep -c '\.unwrap()' "$FILE" 2>/dev/null || echo "0")
            EXPECTS=$(grep -c '\.expect(' "$FILE" 2>/dev/null || echo "0")

            if [ "$UNWRAPS" -gt 0 ] || [ "$EXPECTS" -gt 0 ]; then
              FILES_WITH_ISSUES="$FILES_WITH_ISSUES\n  $FILE: $UNWRAPS unwrap(), $EXPECTS expect()"
              UNWRAP_COUNT=$((UNWRAP_COUNT + UNWRAPS))
              EXPECT_COUNT=$((EXPECT_COUNT + EXPECTS))
            fi
          done

          TOTAL=$((UNWRAP_COUNT + EXPECT_COUNT))

          if [ "$TOTAL" -gt 0 ]; then
            echo ""
            echo "‚ùå ERROR: Found unwrap/expect in production code"
            echo "Found $UNWRAP_COUNT unwrap() and $EXPECT_COUNT expect() calls in:"
            printf "$FILES_WITH_ISSUES\n"
            echo ""
            echo "üîß Fix: Use '?' operator, 'if let', or 'match' instead"
            echo "üìö See: docs/process/SPR_GUIDE.md"
            echo "üîó Install pre-commit hook: ./scripts/install-hooks.sh"
            exit 1
          fi

          echo "‚úÖ No unwrap/expect in production code ($TOTAL found)"

  # FMEA Fix: Coverage enforcement (RPN: 336 ‚Üí 67)
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: Generate coverage report
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Check coverage threshold
        run: |
          # Use portable commands (awk instead of bc/grep -P)
          COVERAGE=$(cargo llvm-cov --all-features --lib --tests --summary-only | \
            grep "lines" | awk '{print $2}' | tr -d '%' || echo "0.0")
          echo "Coverage: $COVERAGE%"
          # Use awk for portable comparison (works on all platforms)
          if [ $(echo "$COVERAGE 70.0" | awk '{print ($1 < $2)}') -eq 1 ]; then
            echo "‚ùå ERROR: Coverage $COVERAGE% is below required threshold 70%"
            echo "Please add tests to improve coverage before merging."
            exit 1
          else
            echo "‚úÖ Coverage $COVERAGE% meets threshold"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true
        # FMEA Fix: Codecov upload is non-blocking (coverage threshold already enforced above)
        # Secret handling: CODECOV_TOKEN is optional, upload fails gracefully if not set

  # Full CI pipeline - runs all checks
  # FMEA Fix: Remove optional jobs from needs (RPN: 210 ‚Üí 21)
  ci:
    name: Full CI Pipeline
    runs-on: ubuntu-latest
    needs: [lint, fmt, test, test-integration, unwrap-check, coverage]
    if: always()
    steps:
      - name: Check job results
        run: |
          # Check critical jobs (all must pass)
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.fmt.result }}" == "failure" ]] || \
             [[ "${{ needs.test.result }}" == "failure" ]] || \
             [[ "${{ needs.test-integration.result }}" == "failure" ]] || \
             [[ "${{ needs.unwrap-check.result }}" == "failure" ]] || \
             [[ "${{ needs.coverage.result }}" == "failure" ]]; then
            echo "‚ùå CI Pipeline failed"
            exit 1
          fi
          echo "‚úÖ All CI checks passed"
          echo "üìä FMEA Improvements Applied:"
          echo "  - Multi-OS testing (Linux, macOS, Windows)"
          echo "  - Multi-Rust version testing (stable, beta, nightly)"
          echo "  - Test retry logic for flaky tests"
          echo "  - Integration tests with Docker/Weaver (RPN: 280 ‚Üí 28)"
          echo "  - Coverage enforcement at 70% threshold (RPN: 336 ‚Üí 67)"
          echo "  - Production code safety (no unwrap/expect)"
          echo "  - Runs on all branches for early feedback"
