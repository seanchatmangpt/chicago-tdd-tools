# Manual Cache Invalidation Workflow
#
# FMEA Fix: CI Cache Corruption (RPN: 108 ‚Üí 22, 80% reduction)
#
# This workflow allows manual clearing of GitHub Actions caches when corruption is suspected.
# Corrupted caches can cause mysterious build failures that are difficult to debug.
#
# When to use:
# - Build fails with "stale dependency" errors
# - Inconsistent build behavior (works sometimes, fails other times)
# - After major dependency updates
# - When CI behaves differently than local builds
#
# How to use:
# 1. Go to Actions tab in GitHub
# 2. Select "Clear CI Caches" workflow
# 3. Click "Run workflow"
# 4. Select branch (usually main/master or your feature branch)
# 5. Confirm execution
#
# What it does:
# - Deletes all caches for the selected branch
# - Next CI run will rebuild from scratch
# - Useful for resolving cache-related issues

name: Clear CI Caches

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to clear caches for (leave empty for current branch)'
        required: false
        default: ''

jobs:
  clear-cache:
    name: Clear GitHub Actions Caches
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clear caches
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üóëÔ∏è  Clearing caches for repository: ${{ github.repository }}"

          BRANCH="${{ github.event.inputs.branch }}"
          if [ -z "$BRANCH" ]; then
            BRANCH="${{ github.ref_name }}"
          fi

          echo "üìç Target branch: $BRANCH"

          # List all caches
          echo ""
          echo "üìã Current caches:"
          gh cache list --limit 100 || echo "No caches found or gh CLI not available"

          # Delete caches for the branch
          echo ""
          echo "üóëÔ∏è  Deleting caches..."

          # GitHub Actions cache API is available via gh CLI
          # Note: This requires repo permissions
          gh cache delete --all || {
            echo "‚ö†Ô∏è  WARNING: Could not delete caches automatically"
            echo "This might be due to permissions or gh CLI availability"
            echo ""
            echo "Manual steps:"
            echo "1. Go to: https://github.com/${{ github.repository }}/actions/caches"
            echo "2. Manually delete caches for branch: $BRANCH"
          }

          echo ""
          echo "‚úÖ Cache clearing process complete"
          echo ""
          echo "Next steps:"
          echo "1. Push a commit to trigger a new CI run"
          echo "2. CI will rebuild all dependencies from scratch"
          echo "3. New cache will be created with fresh builds"

      - name: Verification
        run: |
          echo "üìä Cache Clearing Summary"
          echo "========================"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.event.inputs.branch || github.ref_name }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "üîó Related Documentation:"
          echo "  - FMEA: docs/process/FMEA_TESTS_BUILD_ACTIONS.md"
          echo "  - Root Cause Analysis: docs/analysis/"
          echo ""
          echo "üí° Tip: If builds still fail after cache clearing, check:"
          echo "  - Cargo.lock for dependency conflicts"
          echo "  - Network connectivity to crates.io"
          echo "  - Disk space on CI runners"
