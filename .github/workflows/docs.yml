# Documentation Deployment
#
# Automatically builds and deploys documentation to GitHub Pages:
# - Builds rustdoc documentation
# - Builds mdBook cookbook (if present)
# - Deploys to GitHub Pages on push to main
#
# Triggered by:
# - Push to main/master branches
# - Manual workflow dispatch
#
# Expected duration: ~3 minutes

name: Documentation

on:
  push:
    branches: [main, master]
  workflow_dispatch:

# Only deploy one documentation build at a time
concurrency:
  group: docs-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  pages: write
  id-token: write

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: docs

      - name: Install cargo-make
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-make

      - name: Install mdBook
        uses: taiki-e/install-action@v2
        with:
          tool: mdbook
        continue-on-error: true

      - name: Build rustdoc
        run: cargo doc --no-deps --all-features

      - name: Build cookbook (if present)
        run: |
          if [ -d "cookbook" ]; then
            cargo make cookbook-build || echo "âš ï¸ Cookbook build failed, skipping"
          else
            echo "No cookbook directory found, skipping"
          fi
        continue-on-error: true

      - name: Prepare documentation directory
        run: |
          mkdir -p _site

          # Verify rustdoc was built
          if [ ! -d "target/doc" ]; then
            echo "âŒ ERROR: target/doc directory not found"
            echo "Available directories:"
            ls -la target/ || true
            exit 1
          fi

          echo "ğŸ“‹ Copying rustdoc from target/doc..."
          cp -r target/doc/* _site/
          echo "âœ… Rustdoc copied"

          # Add cookbook if it exists
          if [ -d "cookbook/book" ]; then
            echo "ğŸ“‹ Adding cookbook documentation..."
            cp -r cookbook/book _site/cookbook
            echo "âœ… Cookbook added"
          else
            echo "â„¹ï¸  Cookbook directory not found (optional)"
          fi

          # Create index.html redirect to crate docs
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Chicago TDD Tools Documentation</title>
            <meta http-equiv="refresh" content="0; url=chicago_tdd_tools/">
          </head>
          <body>
            <p>Redirecting to <a href="chicago_tdd_tools/">chicago_tdd_tools documentation</a>...</p>
          </body>
          </html>
          EOF

          echo "ğŸ“‹ Created index.html redirect"
          echo ""
          echo "ğŸ“ Final _site directory structure:"
          ls -la _site/ | head -20

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
          retention-days: 1

      - name: Verify artifact upload
        run: |
          echo "âœ… Artifact uploaded successfully"
          echo "ğŸ“Š Site will be deployed to GitHub Pages"

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Verify GitHub Pages configuration
        run: |
          echo "ğŸ“‹ Deployment Information:"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Event: ${{ github.event_name }}"
          echo ""
          echo "âœ… Deployment will proceed to GitHub Pages"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ github.token }}
