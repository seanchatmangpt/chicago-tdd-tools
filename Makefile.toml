# Chicago TDD Tools Cargo Make Configuration
# Single crate project - simpler than workspace projects
#
# CRITICAL: All commands have timeout protection to prevent freezing
# Better to fail fast than hang forever

# Verify timeout command exists before running any task
[tasks.timeout-check]
description = "Verify timeout command exists (required for all tasks)"
command = "command"
args = ["-v", "timeout"]
ignore_errors = false

# Core development tasks - 5s timeout
[tasks.check]
description = "Check code without building"
command = "timeout"
args = ["5s", "cargo", "check", "--all-targets"]

[tasks.build]
description = "Build in debug mode"
command = "timeout"
args = ["5s", "cargo", "build"]

[tasks.build-release]
description = "Build in release mode"
command = "timeout"
args = ["30s", "cargo", "build", "--release"]

[tasks.clean]
description = "Clean build artifacts"
command = "timeout"
args = ["5s", "cargo", "clean"]

[tasks.fmt]
description = "Format code"
command = "timeout"
args = ["5s", "cargo", "fmt", "--all"]

[tasks.lint]
description = "Run clippy with maximized linting (all, pedantic, nursery, cargo)"
command = "timeout"
args = [
  "5s",
  "cargo",
  "clippy",
  "--all-targets",
  "--all-features",
  "--",
  "-W",
  "clippy::all",
  "-W",
  "clippy::pedantic",
  "-W",
  "clippy::nursery",
  "-W",
  "clippy::cargo",
  "-D",
  "warnings",
]

[tasks.clippy]
alias = "lint"

# Testing tasks - Fast unit tests (1s timeout) and slow integration tests (30s timeout)
# Using cargo-nextest for better timeout enforcement and faster execution
# Testcontainers integration tests excluded from normal iteration (too slow, require Docker)

[tasks.test]
description = "Run unit tests only (fast iteration, excludes testcontainers integration tests)"
command = "timeout"
args = [
  "10s",
  "cargo",
  "nextest",
  "run",
  "--lib",
  "--all-features",
  "--",
  "--skip",
  "testcontainers",
]

[tasks.test-unit]
description = "Unit tests only using cargo-nextest (excludes testcontainers integration tests)"
command = "timeout"
args = [
  "10s",
  "cargo",
  "nextest",
  "run",
  "--lib",
  "--all-features",
  "--",
  "--skip",
  "testcontainers",
]

[tasks.test-integration]
description = "Run testcontainers integration tests only (30s timeout, requires Docker)"
command = "timeout"
args = [
  "30s",
  "cargo",
  "nextest",
  "run",
  "--test",
  "testcontainers",
  "--profile",
  "integration",
  "--features",
  "testcontainers",
]

[tasks.test-all]
description = "Run all tests (unit + integration)"
dependencies = ["test-unit", "test-integration"]

[tasks.test-examples]
description = "Run example tests using cargo-nextest (excludes testcontainers examples)"
command = "timeout"
args = [
  "10s",
  "cargo",
  "nextest",
  "run",
  "--examples",
  "--all-features",
  "--",
  "--skip",
  "testcontainers",
]

[tasks.test-property]
description = "Run property-based tests using cargo-nextest"
command = "timeout"
args = ["10s", "cargo", "nextest", "run", "--features", "property-testing"]

[tasks.test-mutation]
description = "Run mutation testing using cargo-nextest"
command = "timeout"
args = ["10s", "cargo", "nextest", "run", "--features", "mutation-testing"]

[tasks.test-mutation-mutants]
description = "Run mutation testing using cargo-mutants (60s timeout, requires cargo-mutants)"
command = "timeout"
args = ["60s", "cargo", "mutants", "--all-features"]

[tasks.test-snapshot]
description = "Run snapshot tests using cargo-nextest (requires snapshot-testing feature)"
command = "timeout"
args = ["10s", "cargo", "nextest", "run", "--features", "snapshot-testing"]

[tasks.snapshot-review]
description = "Review and accept/reject snapshot changes using cargo-insta (requires cargo-insta: cargo install cargo-insta)"
command = "timeout"
args = ["30s", "cargo", "insta", "review", "--all-features"]

[tasks.snapshot-accept]
description = "Accept all pending snapshot changes (requires cargo-insta: cargo install cargo-insta)"
command = "timeout"
args = ["30s", "cargo", "insta", "accept", "--all-features"]

[tasks.snapshot-reject]
description = "Reject all pending snapshot changes (requires cargo-insta: cargo install cargo-insta)"
command = "timeout"
args = ["30s", "cargo", "insta", "reject", "--all-features"]

[tasks.test-single-threaded]
description = "Run tests in single-threaded mode for deterministic execution"
command = "timeout"
args = [
  "10s",
  "cargo",
  "nextest",
  "run",
  "--test-threads",
  "1",
  "--all-features",
]
env = { "RUST_TEST_THREADS" = "1" }

[tasks.test-verbose]
description = "Run unit tests with verbose output (excludes testcontainers integration tests)"
command = "timeout"
args = [
  "10s",
  "cargo",
  "nextest",
  "run",
  "--lib",
  "--all-features",
  "--",
  "--skip",
  "testcontainers",
  "--nocapture",
]

# Fallback: Standard cargo test (if nextest not available)
[tasks.test-cargo]
description = "Run all tests using standard cargo test (fallback)"
command = "timeout"
args = ["10s", "cargo", "test", "--all-features"]

# Coverage tasks - 30s timeout (coverage can take longer, manual task only, not part of commit/push verification)
[tasks.coverage]
description = "Measure test coverage using cargo-llvm-cov (manual task, not part of commit/push verification)"
command = "timeout"
args = [
  "30s",
  "cargo",
  "llvm-cov",
  "--all-features",
  "--",
  "--test-threads",
  "1",
]

[tasks.coverage-report]
description = "Generate HTML coverage report (manual task, not part of commit/push verification)"
command = "timeout"
args = [
  "30s",
  "cargo",
  "llvm-cov",
  "--all-features",
  "--html",
  "--",
  "--test-threads",
  "1",
]

[tasks.coverage-tarpaulin]
description = "Measure test coverage using cargo-tarpaulin (manual task, not part of commit/push verification)"
command = "timeout"
args = [
  "30s",
  "cargo",
  "tarpaulin",
  "--all-features",
  "--out",
  "Xml",
  "--output-dir",
  "target/coverage",
]

# Pre-commit validation task
# Expected total time: ~20s (fmt: 5s, lint: 5s, test-unit: 10s)
# Individual task timeouts ensure no single task hangs
[tasks.pre-commit]
description = "Run pre-commit validation checks (format, lint, unit tests only)"
dependencies = ["timeout-check", "fmt", "lint", "test-unit"]

# Security and audit tasks - 15s timeout (network operations can take longer)
[tasks.audit]
description = "Security audit"
command = "timeout"
args = ["15s", "cargo", "audit"]
workspace = false

[tasks.audit-outdated]
description = "Check for outdated dependencies"
command = "timeout"
args = ["15s", "cargo", "outdated"]
workspace = false

[tasks.audit-all]
description = "Run all dependency audits"
dependencies = ["audit", "audit-outdated"]
workspace = false

# Documentation tasks - 20s timeout (documentation generation can take longer)
[tasks.docs]
description = "Generate documentation"
command = "timeout"
args = ["20s", "cargo", "doc", "--no-deps", "--all-features", "--open"]

[tasks.docs-build]
description = "Build documentation without opening"
command = "timeout"
args = ["20s", "cargo", "doc", "--no-deps", "--all-features"]

# CI/CD tasks
# Expected total time: ~120s (fmt: 5s, lint: 5s, test-unit: 1s, audit-all: 30s)
# Individual task timeouts ensure no single task hangs
[tasks.ci]
description = "Run CI pipeline (unit tests only, excludes slow integration tests)"
dependencies = ["timeout-check", "fmt", "lint", "test-unit", "audit-all"]

# Expected total time: ~180s (ci: 120s, docs-build: 20s)
[tasks.release]
description = "Create a release"
dependencies = ["ci", "docs-build"]

# Development workflow
# Expected total time: ~25s (check: 5s, fmt: 5s, test-unit: 10s)
[tasks.dev]
description = "Development workflow (check, format, test)"
dependencies = ["timeout-check", "check", "fmt", "test-unit"]

# Expected total time: ~30s (build: 5s, test: 10s, lint: 5s)
[tasks.all]
description = "Full validation (build, test, lint)"
dependencies = ["timeout-check", "build", "test", "lint"]
