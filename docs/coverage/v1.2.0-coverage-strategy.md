# v1.2.0 Coverage Strategy and Goals

## Executive Summary

Chicago TDD Tools v1.2.0 introduces **mandatory 85% line coverage** enforcement, up from v1.1.0's warning-only 70% threshold. This document outlines the coverage strategy, goals, and improvement plan.

## Coverage Metrics

| Metric | v1.1.0 | v1.2.0 Goal | Status |
|--------|--------|------------|--------|
| Minimum line coverage | 70% (warning) | **85%** (enforced) | ðŸ“ˆ +15% |
| Production code target | N/A | 90%+ | New |
| Test utilities target | N/A | 80%+ | New |
| CI/CD enforcement | Warning only | Hard requirement | âœ… Blocking |

## Rationale: Why 85%?

### Coverage Science
- **50% coverage**: Catches most obvious bugs
- **70% coverage**: Good baseline (v1.1.0 threshold)
- **85% coverage**: High confidence, catches 95% of bugs (Codecov data)
- **95%+ coverage**: Diminishing returns, requires test maintenance burden

### Chicago TDD Context
- Zero production panics/unwraps (enforced via linting)
- Poka-Yoke design (error-proofing) requires comprehensive error path testing
- 85% is achievable without excessive test maintenance
- Aligns with industry best practices for testing frameworks

## Current Status

Run coverage report:
```bash
cargo llvm-cov --html --all-features
open target/llvm-cov/html/index.html
```

## Improvement Plan

### Phase 1: Identify Gaps (Week 1-2)
1. Run: `cargo llvm-cov --html --all-features`
2. Review HTML report focusing on:
   - Error paths (highest priority)
   - Guard constraint validation
   - OTEL integration points
   - Edge cases in mutation testing

### Phase 2: Priority Test Addition (Week 2-4)
Focus on adding tests for:

#### High Priority (ROI > 2%)
- **Guard validation error paths** - Constraint violations
- **Validation module** - Run/Batch constraint enforcement
- **Mutation testing** - Edge cases in mutation detection
- **OTEL types** - Span/metric creation and serialization

#### Medium Priority (ROI 0.5-2%)
- **CLI testing helpers** - Error conditions
- **Coverage tracker** - Edge cases
- **Assertion builders** - Various configurations

#### Low Priority (ROI < 0.5%)
- **Builder patterns** - Already well-covered
- **Test utilities** - Most paths tested

### Phase 3: Validation (Week 4-5)
1. Run coverage report after each batch of tests
2. Verify all error paths are covered
3. Check for unreachable code (dead code elimination)
4. Ensure tests are meaningful (not just coverage hits)

## Adding Tests for Coverage

### Quick Start
```bash
# Generate coverage report with details
cargo llvm-cov --html --all-features

# Find uncovered lines
grep -r "% uncovered" target/llvm-cov/

# View in browser
open target/llvm-cov/html/index.html
```

### Test Pattern: Error Paths
```rust
#[test]
fn test_guard_constraint_error_messages() {
    // Test all error variants
    let errors = vec![
        GuardConstraintError::MaxRunLengthExceeded(9, 8),
        GuardConstraintError::MaxBatchSizeExceeded(1500, 1000),
    ];

    for error in errors {
        let display = format!("{error}");
        assert!(!display.is_empty());
        // Verify error message contains key information
    }
}
```

### Test Pattern: Edge Cases
```rust
#[test]
fn test_boundary_conditions() {
    // Test minimum valid value
    let validator = GuardValidator::new();
    assert!(validator.validate_run_len(0).is_ok());

    // Test maximum valid value
    assert!(validator.validate_run_len(8).is_ok());

    // Test boundary violation
    assert!(validator.validate_run_len(9).is_err());
}
```

## Integration with CI/CD

### Blocking Requirement
Coverage is now a **hard requirement** for merges:

```yaml
- name: Check coverage threshold (â‰¥85% required)
  run: cargo llvm-cov --all-features --lib --tests --summary-only
  # Fails CI if coverage < 85%
```

### PR Workflow
1. Developer runs: `cargo llvm-cov --html`
2. Reviews uncovered lines in browser
3. Adds tests for critical paths
4. Pushes to PR
5. CI validates coverage â‰¥ 85%
6. PR can merge if coverage passes

## Maintenance

### Preventing Coverage Regression
- Every new feature must include tests
- Error paths must be tested (80% of bugs are in error handling)
- Coverage report reviewed before each release
- Target increase 1-2% per minor release

### Per-Module Goals
| Module | Target | Why |
|--------|--------|-----|
| `core` | 90% | Critical for all tests |
| `validation` | 90% | Guards must be reliable |
| `testing` | 85% | Various test patterns |
| `integration` | 85% | External dependencies |
| `observability` | 85% | OTEL/Weaver integration |

## Tools

### Generate Coverage Report
```bash
# HTML report with per-file breakdown
cargo llvm-cov --html --all-features

# LCOV format for CI/Codecov
cargo llvm-cov --lcov --all-features --output-path lcov.info

# Summary only
cargo llvm-cov --summary-only --all-features
```

### Coverage by Module
```bash
# Per-package coverage
cargo llvm-cov --all-features --package chicago-tdd-tools

# Specific features
cargo llvm-cov --features weaver,testing-full
```

## Future Improvements

### v1.3.0+
- Consider mutation score requirement (complement to line coverage)
- Implement branch coverage tracking
- Add coverage trend visualization
- Integrate with code review tools

## References

- [LLVM Coverage Documentation](https://rust-lang.github.io/rustup/cross-compilation.html)
- [Codecov Best Practices](https://docs.codecov.com/)
- [Coverage-Driven Test Design](https://www.guru99.com/code-coverage-tutorial.html)

## Questions?

Contact the development team if you need help improving coverage or have questions about the strategy.
